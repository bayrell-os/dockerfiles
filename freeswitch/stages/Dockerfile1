FROM bayrell/freeswitch:stage0

ADD install /src/install/
COPY install/run.sh /src/install/run.sh
ADD fusionpbx /var/www/fusionpbx

RUN cd ~; \	
	
	yum install -y iproute freeswitch-lua freeswitch-xml-cdr freeswitch-python freeswitch-endpoint-rtmp freeswitch-codec-opus freeswitch-application-translate; \
	
	mv /etc/freeswitch /etc/freeswitch.orig; \
	mkdir /data; \
	mkdir /etc/freeswitch; \
	mkdir /etc/fusionpbx; \
	cp -R /var/www/fusionpbx/resources/templates/conf/* /etc/freeswitch; \
	cp -f /src/install/supervisor/* /etc/supervisord.d; \
	
	chown -R freeswitch:daemon /var/www/fusionpbx; \
	chown -R freeswitch:daemon /etc/freeswitch; \
	chown -R freeswitch:daemon /var/log/freeswitch; \
	chown -R freeswitch:daemon /var/run/freeswitch; \
	chown -R freeswitch:daemon /var/lib/freeswitch; \
	chown -R freeswitch:daemon /usr/share/freeswitch; \
	chown -R freeswitch:daemon /etc/fusionpbx; \
	chown -R freeswitch:daemon /var/run/session; \
	
	find /etc/freeswitch -type d -exec chmod 770 {} +; \
	find /var/lib/freeswitch -type d -exec chmod 770 {} +;  \
	find /var/log/freeswitch -type d -exec chmod 770 {} +;  \
	find /usr/share/freeswitch -type d -exec chmod 770 {} +;  \
	find /etc/freeswitch -type f -exec chmod 664 {} +;  \
	find /var/lib/freeswitch -type f -exec chmod 664 {} +;  \
	find /var/log/freeswitch -type f -exec chmod 664 {} +;  \
	find /usr/share/freeswitch -type f -exec chmod 664 {} +;  \
	
	
	mkdir -p /data/fusionpbx && mv -fT /var/www/fusionpbx /data/fusionpbx && ln -s /data/fusionpbx /var/www/fusionpbx; \
	mkdir -p /data/etc/freeswitch && mv -fT /etc/freeswitch /data/etc/freeswitch && ln -s /data/etc/freeswitch /etc/freeswitch; \
	mkdir -p /data/etc/fusionpbx && mv -fT /etc/fusionpbx /data/etc/fusionpbx && ln -s /data/etc/fusionpbx /etc/fusionpbx; \
	mkdir -p /data/log && mv -fT /var/log/freeswitch /data/log && ln -s /data/log /var/log/freeswitch; \
	mkdir -p /data/run && mv -fT /var/run/freeswitch /data/run && ln -s /data/run /var/run/freeswitch; \
	mkdir -p /data/lib && mv -fT /var/lib/freeswitch /data/lib && ln -s /data/lib /var/lib/freeswitch; \
	mkdir -p /data/session && mv -fT /var/run/session /data/session && ln -s /data/session /var/run/session; \
	
	mkdir -p /src/install/data && mv -fT /data /src/install/data; \
	chmod +x /src/install/run.sh; \
	echo "OK";
	
	
VOLUME ["/data"]
CMD ["/src/install/run.sh"]	
